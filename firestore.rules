rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Check if user is a member of a group
    function isGroupMember(groupId) {
      return exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid));
    }

    // Helper: Check if user is an admin of a group
    function isGroupAdmin(groupId) {
      let memberDoc = get(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid));
      return memberDoc.data != null && memberDoc.data.role == 'admin';
    }

    // Users: any authenticated user can read profiles (for band member display names)
    // Only the owner can write their own profile
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Groups
    match /groups/{groupId} {
      // Any authenticated user can read a group (needed for join by code)
      allow read: if request.auth != null;

      // Only members can update (for now, no updates needed from client)
      allow update: if request.auth != null && isGroupMember(groupId);

      // Any authenticated user can create a group
      allow create: if request.auth != null;

      // Only admin can delete (not implemented yet)
      allow delete: if request.auth != null && isGroupAdmin(groupId);

      // Group members subcollection
      match /members/{memberId} {
        // Members can read other members, OR user can read their own (for join check)
        allow read: if request.auth != null &&
          (isGroupMember(groupId) || request.auth.uid == memberId);

        // User can add themselves (joining)
        allow create: if request.auth != null && request.auth.uid == memberId;

        // Admin can update roles, OR user can update their own (for Groove Sync following state)
        allow update: if request.auth != null && (
          isGroupAdmin(groupId) || request.auth.uid == memberId
        );
        allow delete: if request.auth != null && (
          request.auth.uid == memberId || isGroupAdmin(groupId)
        );
      }

      // Groove Sync session subcollection
      match /session/{sessionId} {
        // Any group member can read the session
        allow read: if request.auth != null && isGroupMember(groupId);

        // Any group member can create/update/delete the session (leader management)
        allow create, update, delete: if request.auth != null && isGroupMember(groupId);
      }
    }

    // Setlists - restricted to group members
    match /setlists/{setlistId} {
      // Read/update/delete: must be member of the setlist's group
      allow read, update, delete: if request.auth != null &&
        resource.data.groupId != null &&
        isGroupMember(resource.data.groupId);

      // Create: must be member of the target group
      allow create: if request.auth != null &&
        request.resource.data.groupId != null &&
        isGroupMember(request.resource.data.groupId);
    }

    // Audit log - append only, readable by group members
    match /auditLog/{logId} {
      allow read: if request.auth != null &&
        resource.data.groupId != null &&
        isGroupMember(resource.data.groupId);

      // Any authenticated user can create (logging their own actions)
      allow create: if request.auth != null;

      // No updates or deletes
      allow update, delete: if false;
    }
  }
}
